---
import Layout from "../layouts/Layout.astro";
import CategoryArea from "../components/CategoryArea.astro";
import { tabInfos, type TabKeys } from "../components/Tabs.astro";
import { allCategories, type Category } from "../store";

const tabKey: TabKeys = `main`;
const tabName = tabInfos[tabKey].ja;
const layoutInfo = {
  tabKey,
  tabName,
};

const names: { [K in Category]: string } = {
  eyesColors: `目の色`,
  eyesShapes: `目の形状`,
  eyebrows: `眉毛`,
  eyelashes: `睫毛`,
  hairLengths: `髪の長さ`,
  hairStyles: `髪型`,
} as const;

const n = allCategories.length;
const colors: { [K in Category]: string } = {
  eyesColors: `hsl(${(0 * 360) / n}deg 100% 50% / 30%)`,
  eyesShapes: `hsl(${(1 * 360) / n}deg 100% 50% / 30%)`,
  eyebrows: `hsl(${(2 * 360) / n}deg 100% 50% / 30%)`,
  eyelashes: `hsl(${(3 * 360) / n}deg 100% 50% / 30%)`,
  hairLengths: `hsl(${(4 * 360) / n}deg 100% 50% / 30%)`,
  hairStyles: `hsl(${(5 * 360) / n}deg 100% 50% / 30%)`,
} as const;
---

<Layout {...layoutInfo}>
  <before-unload-script data-prod={import.meta.env.PROD} style="display:none"
  ></before-unload-script>
  {
    allCategories.map((category) => (
      <CategoryArea name={names[category]} key={category} />
    ))
  }
  <pre
    id="prompt-output">
    {allCategories.map((category) => 
      (<code class={category} style={`background-color:${colors[category]}`} />)
      )}
  </pre>
</Layout>

<script>
  import { allCategories, promptStates } from "../store";

  promptStates.subscribe((promptStates) => {
    for (const category of allCategories) {
      const categoryMatches = promptStates.filter(
        ({ category: c }) => c === category,
      );
      const resultPrompts = categoryMatches
        .map(({ prompt, isEnable }) => (isEnable ? `${prompt}, ` : ``))
        .join(``);

      const code = document.querySelector(`#prompt-output > .${category}`)!;
      code.textContent = resultPrompts;
    }
  });

  // Enable scripts only production mode.
  class BeforeUnloadScript extends HTMLElement {
    constructor() {
      super();

      const isProduction = this.dataset.prod === ``;
      if (isProduction) {
        window.addEventListener(`beforeunload`, (event: BeforeUnloadEvent) => {
          event.preventDefault();
          event.returnValue = ``;
        });
      }
    }
  }

  customElements.define(`before-unload-script`, BeforeUnloadScript);
</script>

<style>
  div {
    padding: 1em;
    background-color: rgb(100% 100% 100% / 0.05);
    border-radius: 1rem;
    display: flex;
    flex-flow: row wrap;
    justify-content: center;
    gap: 1em;
  }

  pre {
    background-color: rgb(10% 10% 10%);
    border-radius: 1rem;
    padding: 1rem;
    white-space: pre-wrap;
  }
</style>

---
import { categorySet } from "../libs/prompts-store";
import SliderButton from "./SliderButton.astro";

const n = categorySet.size;
const categoryInfo = new Map(
  [...categorySet].map((c, index) => [
    c,
    {
      className: c.replace(` `, `-`),
      color: `hsl(${
        (360 * index) / (2 * n) + (index % 2 === 0 ? 0 : 180)
      }deg 100% 50% / 30%)`,
    },
  ]),
);
---

<section class="flex-column">
  <header>
    <h2>å‡ºåŠ›</h2>
  </header>
  <div class="flex-column">
    <div class="flex-row">
      <p>1è¡Œå‡ºåŠ›</p>
      <SliderButton key="oneLine" />
    </div>
  </div>
  <div class="flex-row">
    <pre
      id="prompts-output">{[...categorySet].map((category) =>
      (<code class={categoryInfo.get(category)?.className} style={`background-color:${categoryInfo.get(category)?.color}`} /><br class="line-break" />))
        }</pre>
    <button id="prompts-copy-button">ðŸ“‹</button>
  </div>
</section>

<script>
  import {
    categorySet,
    promptEnableInfoStore,
    getDefinesByCategory,
  } from "../libs/prompts-store";
  import { sliderButtonStoreMap } from "../libs/slider-button-store";
  import { computed } from "nanostores";

  const oneLineStore = sliderButtonStoreMap.get(`oneLine`)!;

  const outputMaterials = computed(
    [oneLineStore, promptEnableInfoStore],
    (isOneLine, promptEnableInfo) => ({
      isOneLine,
      promptEnableInfo,
    }),
  );

  outputMaterials.subscribe(({ isOneLine, promptEnableInfo }) => {
    for (const category of categorySet) {
      const categoryDefines = getDefinesByCategory(category);
      const categoryOutputs = categoryDefines
        .map(({ prompt }) => (promptEnableInfo[prompt] ? `${prompt}, ` : ``))
        .join(``);

      const code = document.querySelector(`#prompts-output > .${category}`)!;
      code.textContent = categoryOutputs;
    }

    const brs: NodeListOf<HTMLBRElement> = document.querySelectorAll(
      `#prompts-output > .line-break`,
    );
    for (const br of brs) {
      br.style.display = isOneLine ? `none` : `unset`;
    }
  });

  const button = document.querySelector(
    `#prompts-copy-button`,
  )! as HTMLButtonElement;
  const pre = document.querySelector(`#prompts-output`)! as HTMLPreElement;

  button.addEventListener(`click`, () => {
    navigator.clipboard.writeText(pre.textContent!);
    button.classList.add(`transition`);
  });
  button.addEventListener(`transitioncancel`, () =>
    button.classList.remove(`transition`),
  );
  button.addEventListener(`transitionend`, () =>
    button.classList.remove(`transition`),
  );
</script>

<style>
  .flex-row {
    display: flex;
    flex-flow: row nowrap;
    gap: 1rem;
    align-items: center;
  }

  .flex-column {
    display: flex;
    flex-flow: column nowrap;
    gap: 1rem;
  }

  section {
    background-color: rgb(var(--background-sub));
    border-radius: 1rem;
    padding: 1rem;
  }

  h2 {
    font-size: 1.5rem;
  }

  pre {
    background-color: rgb(10% 10% 10%);
    border-radius: 1rem;
    padding: 1rem;
    white-space: pre-wrap;
    flex: 1 1 0;
  }

  button {
    flex: 0 0 3rem;
    aspect-ratio: 1 / 1;
    border-radius: 9999px;
    cursor: pointer;
    font-size: 1.5rem;
    transition-duration: 200ms;
    rotate: 0deg;
  }

  .transition {
    rotate: 360deg;
  }
</style>
